package com.example.itemmanagement.data.dao.wishlist

import androidx.room.*
import com.example.itemmanagement.data.entity.wishlist.WishlistItemEntity
import com.example.itemmanagement.data.entity.wishlist.WishlistPriority
import com.example.itemmanagement.data.entity.wishlist.WishlistUrgency
import kotlinx.coroutines.flow.Flow

/**
 * 心愿单数据访问对象
 * 遵循MVVM原则，提供心愿单物品的数据库操作接口
 */
@Dao
interface WishlistDao {
    
    // === 基础查询操作 ===
    
    /**
     * 获取所有激活状态的心愿单物品
     */
    @Query("SELECT * FROM wishlist_items WHERE isActive = 1 AND isPaused = 0 ORDER BY priority DESC, addDate DESC")
    fun getAllActiveItems(): Flow<List<WishlistItemEntity>>
    
    /**
     * 根据ID获取心愿单物品
     */
    @Query("SELECT * FROM wishlist_items WHERE id = :id")
    suspend fun getById(id: Long): WishlistItemEntity?
    
    /**
     * 获取所有心愿单物品（包括非激活状态）
     */
    @Query("SELECT * FROM wishlist_items ORDER BY addDate DESC")
    fun getAllItems(): Flow<List<WishlistItemEntity>>
    
    /**
     * 根据名称搜索心愿单物品
     */
    @Query("SELECT * FROM wishlist_items WHERE isActive = 1 AND (name LIKE '%' || :searchText || '%' OR brand LIKE '%' || :searchText || '%') ORDER BY priority DESC")
    suspend fun searchItems(searchText: String): List<WishlistItemEntity>
    
    // === 分类和筛选查询 ===
    
    /**
     * 根据分类获取心愿单物品
     */
    @Query("SELECT * FROM wishlist_items WHERE isActive = 1 AND category = :category ORDER BY priority DESC, addDate DESC")
    fun getItemsByCategory(category: String): Flow<List<WishlistItemEntity>>
    
    /**
     * 根据优先级获取心愿单物品
     */
    @Query("SELECT * FROM wishlist_items WHERE isActive = 1 AND priority = :priority ORDER BY addDate DESC")
    fun getItemsByPriority(priority: WishlistPriority): Flow<List<WishlistItemEntity>>
    
    /**
     * 根据紧急程度获取心愿单物品
     */
    @Query("SELECT * FROM wishlist_items WHERE isActive = 1 AND urgency = :urgency ORDER BY priority DESC")
    fun getItemsByUrgency(urgency: WishlistUrgency): Flow<List<WishlistItemEntity>>
    
    /**
     * 获取高优先级物品（紧急和高优先级）
     */
    @Query("SELECT * FROM wishlist_items WHERE isActive = 1 AND (priority = 'URGENT' OR priority = 'HIGH') ORDER BY priority DESC, urgency DESC")
    fun getHighPriorityItems(): Flow<List<WishlistItemEntity>>
    
    // === 价格相关查询 ===
    
    /**
     * 获取启用价格跟踪的物品
     */
    @Query("SELECT * FROM wishlist_items WHERE isActive = 1 AND isPriceTrackingEnabled = 1 ORDER BY lastPriceCheck ASC")
    suspend fun getPriceTrackingItems(): List<WishlistItemEntity>
    
    /**
     * 获取达到目标价格的物品
     */
    @Query("SELECT * FROM wishlist_items WHERE isActive = 1 AND targetPrice IS NOT NULL AND currentPrice IS NOT NULL AND currentPrice <= targetPrice ORDER BY addDate DESC")
    suspend fun getItemsReachedTargetPrice(): List<WishlistItemEntity>
    
    /**
     * 获取价格下降的物品
     */
    @Query("SELECT * FROM wishlist_items WHERE isActive = 1 AND currentPrice IS NOT NULL AND lowestPrice IS NOT NULL AND currentPrice <= lowestPrice ORDER BY addDate DESC")
    suspend fun getPriceDroppedItems(): List<WishlistItemEntity>
    
    /**
     * 根据价格范围查询
     */
    @Query("SELECT * FROM wishlist_items WHERE isActive = 1 AND currentPrice BETWEEN :minPrice AND :maxPrice ORDER BY currentPrice ASC")
    suspend fun getItemsByPriceRange(minPrice: Double, maxPrice: Double): List<WishlistItemEntity>
    
    /**
     * 获取已购买/已实现的物品
     */
    @Query("SELECT * FROM wishlist_items WHERE achievedDate IS NOT NULL ORDER BY achievedDate DESC")
    fun getPurchasedItems(): Flow<List<WishlistItemEntity>>
    
    /**
     * 获取未购买的物品（正常的心愿单物品）
     */
    @Query("SELECT * FROM wishlist_items WHERE isActive = 1 AND achievedDate IS NULL ORDER BY priority DESC, urgency DESC, addDate DESC")
    fun getUnpurchasedItems(): Flow<List<WishlistItemEntity>>
    
    // === 统计查询 ===
    
    /**
     * 获取心愿单物品总数
     */
    @Query("SELECT COUNT(*) FROM wishlist_items WHERE isActive = 1")
    suspend fun getActiveItemsCount(): Int
    
    /**
     * 获取已实现的愿望数量
     */
    @Query("SELECT COUNT(*) FROM wishlist_items WHERE achievedDate IS NOT NULL")
    suspend fun getAchievedItemsCount(): Int
    
    /**
     * 获取分类统计
     */
    @Query("SELECT category, COUNT(*) as count FROM wishlist_items WHERE isActive = 1 GROUP BY category ORDER BY count DESC")
    suspend fun getCategoryStats(): List<CategoryCount>
    
    /**
     * 获取优先级分布
     */
    @Query("SELECT priority, COUNT(*) as count FROM wishlist_items WHERE isActive = 1 GROUP BY priority")
    suspend fun getPriorityDistribution(): List<PriorityCount>
    
    /**
     * 获取总预估价值
     */
    @Query("SELECT SUM(price) FROM wishlist_items WHERE isActive = 1 AND price IS NOT NULL")
    suspend fun getTotalEstimatedValue(): Double?
    
    /**
     * 获取总当前价值
     */
    @Query("SELECT SUM(currentPrice) FROM wishlist_items WHERE isActive = 1 AND currentPrice IS NOT NULL")
    suspend fun getTotalCurrentValue(): Double?
    
    // === 数据修改操作 ===
    
    /**
     * 插入新的心愿单物品
     */
    @Insert
    suspend fun insert(item: WishlistItemEntity): Long
    
    /**
     * 批量插入心愿单物品
     */
    @Insert
    suspend fun insertAll(items: List<WishlistItemEntity>)
    
    /**
     * 更新心愿单物品
     */
    @Update
    suspend fun update(item: WishlistItemEntity)
    
    /**
     * 删除心愿单物品
     */
    @Delete
    suspend fun delete(item: WishlistItemEntity)
    
    /**
     * 根据ID删除心愿单物品
     */
    @Query("DELETE FROM wishlist_items WHERE id = :id")
    suspend fun deleteById(id: Long)
    
    // === 状态更新操作 ===
    
    /**
     * 软删除（设置为非激活状态）
     */
    @Query("UPDATE wishlist_items SET isActive = 0 WHERE id = :id")
    suspend fun softDelete(id: Long)
    
    /**
     * 恢复心愿单物品
     */
    @Query("UPDATE wishlist_items SET isActive = 1 WHERE id = :id")
    suspend fun restore(id: Long)
    
    /**
     * 暂停/恢复价格跟踪
     */
    @Query("UPDATE wishlist_items SET isPaused = :isPaused WHERE id = :id")
    suspend fun setPauseStatus(id: Long, isPaused: Boolean)
    
    /**
     * 更新优先级
     */
    @Query("UPDATE wishlist_items SET priority = :priority, lastModified = :timestamp WHERE id = :id")
    suspend fun updatePriority(id: Long, priority: WishlistPriority, timestamp: Long = System.currentTimeMillis())
    
    /**
     * 更新当前价格
     */
    @Query("UPDATE wishlist_items SET currentPrice = :price, lastPriceCheck = :checkTime, lastModified = :timestamp WHERE id = :id")
    suspend fun updateCurrentPrice(id: Long, price: Double, checkTime: Long, timestamp: Long = System.currentTimeMillis())
    
    /**
     * 标记为已实现
     */
    @Query("UPDATE wishlist_items SET achievedDate = :achievedDate, isActive = 0, relatedItemId = :relatedItemId WHERE id = :id")
    suspend fun markAsAchieved(id: Long, achievedDate: Long, relatedItemId: Long? = null)
    
    /**
     * 增加查看次数
     */
    @Query("UPDATE wishlist_items SET viewCount = viewCount + 1, lastViewDate = :viewDate WHERE id = :id")
    suspend fun incrementViewCount(id: Long, viewDate: Long = System.currentTimeMillis())
    
    // === 批量操作 ===
    
    /**
     * 批量更新优先级
     */
    @Query("UPDATE wishlist_items SET priority = :priority WHERE id IN (:ids)")
    suspend fun batchUpdatePriority(ids: List<Long>, priority: WishlistPriority)
    
    /**
     * 批量软删除
     */
    @Query("UPDATE wishlist_items SET isActive = 0 WHERE id IN (:ids)")
    suspend fun batchSoftDelete(ids: List<Long>)
    
    /**
     * 清理旧的已实现愿望（超过指定天数）
     */
    @Query("DELETE FROM wishlist_items WHERE achievedDate IS NOT NULL AND achievedDate < :cutoffDate")
    suspend fun cleanupOldAchievedItems(cutoffDate: Long)
}

/**
 * 分类统计数据类
 */
data class CategoryCount(
    val category: String,
    val count: Int
)

/**
 * 优先级统计数据类
 */
data class PriorityCount(
    val priority: WishlistPriority,
    val count: Int
)

