// å½’æ¡£åŸå› ï¼šå¸ƒå±€æƒé‡å†²çªå¯¼è‡´TextView width=0ï¼Œç•Œé¢ç©ºç™½
// å½’æ¡£æ—¶é—´ï¼š2025-09-27
// é—®é¢˜è¯Šæ–­ï¼šæ•°æ®æµå®Œå…¨æ­£å¸¸ï¼Œä½†æ‰€æœ‰TextViewå®½åº¦ä¸º0ï¼Œæ— æ³•æ˜¾ç¤ºå†…å®¹
// æ–°ç‰ˆæœ¬ï¼šé‡‡ç”¨ç®€æ´å¸ƒå±€é‡æ–°è®¾è®¡

package com.example.itemmanagement.ui.detail

import android.os.Bundle
import android.view.*
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AlertDialog
import androidx.core.content.ContextCompat
import androidx.fragment.app.Fragment
import androidx.fragment.app.viewModels
import androidx.navigation.fragment.findNavController
import androidx.navigation.fragment.navArgs
import androidx.recyclerview.widget.LinearLayoutManager
import com.example.itemmanagement.ItemManagementApplication
import com.example.itemmanagement.R
import com.example.itemmanagement.databinding.FragmentItemDetailBinding
import com.example.itemmanagement.ui.detail.adapter.PhotoAdapter
import com.example.itemmanagement.ui.detail.adapter.TagAdapter
import com.example.itemmanagement.data.model.OpenStatus
import java.text.SimpleDateFormat
import java.util.Calendar
import java.util.Date
import java.util.Locale
import java.util.concurrent.TimeUnit
import android.widget.LinearLayout

class ItemDetailFragment : Fragment() {
    private var _binding: FragmentItemDetailBinding? = null
    private val binding get() = _binding!!

    private val viewModel: ItemDetailViewModel by viewModels {
        ItemDetailViewModelFactory(
            (requireActivity().application as ItemManagementApplication).repository
        )
    }

    private val args: ItemDetailFragmentArgs by navArgs()
    private val dateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
    private lateinit var photoAdapter: PhotoAdapter
    private lateinit var tagAdapter: TagAdapter

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setHasOptionsMenu(true) // å¯ç”¨é€‰é¡¹èœå•
    }
    
    override fun onCreateOptionsMenu(menu: Menu, inflater: MenuInflater) {
        inflater.inflate(R.menu.menu_item_detail, menu)
        super.onCreateOptionsMenu(menu, inflater)
    }
    
    override fun onOptionsItemSelected(item: MenuItem): Boolean {
        return when (item.itemId) {
            R.id.action_edit -> {
                navigateToEditItem()
                true
            }
            R.id.action_delete -> {
                showDeleteConfirmationDialog()
                true
            }
            else -> super.onOptionsItemSelected(item)
        }
    }
    
    private fun showDeleteConfirmationDialog() {
        AlertDialog.Builder(requireContext())
            .setTitle("åˆ é™¤ç‰©å“")
            .setMessage("ç¡®å®šè¦åˆ é™¤æ­¤ç‰©å“å—ï¼Ÿ")
            .setPositiveButton("åˆ é™¤") { _, _ ->
                // è°ƒç”¨ViewModelä¸­çš„åˆ é™¤æ–¹æ³•
                viewModel.deleteItem(args.itemId)
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View {
        _binding = FragmentItemDetailBinding.inflate(inflater, container, false)
        return binding.root
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        setupViewPager()
        setupTagsRecyclerView()
        setupButtons()
        viewModel.loadItem(args.itemId)
        observeItem()
        observeError()
        observeNavigation()
        
        // è¯Šæ–­ä»£ç ï¼šå¼ºåˆ¶æ˜¾ç¤ºä¸€äº›å†…å®¹æ¥æµ‹è¯•å¸ƒå±€
        binding.root.post {
            android.util.Log.d("DetailDebug", "ğŸ”§ å¼€å§‹è¯Šæ–­TextViewæ˜¾ç¤ºé—®é¢˜")
            
            // å¼ºåˆ¶è®¾ç½®ä¸€äº›æµ‹è¯•å†…å®¹
            binding.quantityTextView.text = "æµ‹è¯•æ•°é‡"
            binding.quantityTextView.visibility = android.view.View.VISIBLE
            
            binding.locationTextView.text = "æµ‹è¯•ä½ç½®"
            binding.locationContainer.visibility = android.view.View.VISIBLE
            
            binding.priceTextView.text = "æµ‹è¯•ä»·æ ¼"
            binding.priceContainer.visibility = android.view.View.VISIBLE
            
            // æ£€æŸ¥TextViewçš„å®é™…å°ºå¯¸
            android.util.Log.d("DetailDebug", "ğŸ“ quantityTextView: width=${binding.quantityTextView.width}, height=${binding.quantityTextView.height}, visibility=${binding.quantityTextView.visibility}")
            android.util.Log.d("DetailDebug", "ğŸ“ locationTextView: width=${binding.locationTextView.width}, height=${binding.locationTextView.height}, visibility=${binding.locationTextView.visibility}")
            android.util.Log.d("DetailDebug", "ğŸ“ priceTextView: width=${binding.priceTextView.width}, height=${binding.priceTextView.height}, visibility=${binding.priceTextView.visibility}")
        }
    }
    
    private fun observeNavigation() {
        viewModel.navigateBack.observe(viewLifecycleOwner) { shouldNavigate ->
            if (shouldNavigate) {
                findNavController().navigateUp()
                viewModel.onNavigationComplete()
            }
        }
    }

    private fun setupViewPager() {
        // è®¾ç½®ç…§ç‰‡ViewPager
        photoAdapter = PhotoAdapter()
        binding.photoViewPager.adapter = photoAdapter
    }
    
    private fun setupTagsRecyclerView() {
        // è®¾ç½®æ ‡ç­¾RecyclerView
        tagAdapter = TagAdapter()
        binding.tagsRecyclerView.apply {
            layoutManager = LinearLayoutManager(context, LinearLayoutManager.HORIZONTAL, false)
            adapter = tagAdapter
        }
    }
    
    private fun setupButtons() {
        // å¤‡æ³¨å±•å¼€/æ”¶èµ·æŒ‰é’®
        binding.expandButton.setOnClickListener {
            if (binding.customNoteTextView.maxLines == 5) {
                binding.customNoteTextView.maxLines = Integer.MAX_VALUE
                binding.expandButton.text = "æ”¶èµ·"
            } else {
                binding.customNoteTextView.maxLines = 5
                binding.expandButton.text = "å±•å¼€"
            }
        }
    }
    
    private fun navigateToEditItem() {
        // å¯¼èˆªåˆ°ç¼–è¾‘ç‰©å“é¡µé¢ï¼ˆä½¿ç”¨æ–°æ¶æ„ï¼‰
        val action = ItemDetailFragmentDirections.actionNavigationItemDetailToEditItemFragment(
            itemId = args.itemId
        )
        findNavController().navigate(action)
    }

    private fun observeItem() {
        viewModel.item.observe(viewLifecycleOwner) { item ->
            binding.apply {
                // åŸºæœ¬ä¿¡æ¯
                nameTextView.text = item.name
                quantityTextView.text = "${formatNumber(item.quantity)} ${item.unit ?: "ä¸ª"}"
                
                // è¯„åˆ†
                val ratingContainer = binding.root.findViewById<View>(R.id.ratingContainer)
                item.rating?.let {
                    binding.ratingBar.rating = it.toFloat()
                    ratingContainer?.visibility = View.VISIBLE
                } ?: run {
                    ratingContainer?.visibility = View.GONE
                }
                
                // åˆ†ç±»å’Œå­åˆ†ç±»
                // æ‰¾åˆ°åˆ†ç±»å®¹å™¨
                val categoryContainer = binding.root.findViewById<LinearLayout>(R.id.categoryContainer)
                
                if (item.category.isNullOrBlank() || item.category == "æœªæŒ‡å®š") {
                    // å¦‚æœåˆ†ç±»ä¸ºç©ºæˆ–æœªæŒ‡å®šï¼Œéšè—æ•´ä¸ªåˆ†ç±»å®¹å™¨
                    categoryContainer?.visibility = View.GONE
                } else {
                    setCategoryTag(categoryTextView, item.category, getCategoryColor(item.category))
                    categoryTextView.visibility = View.VISIBLE
                    
                    // å­åˆ†ç±»å¤„ç†
                    item.subCategory?.let {
                        if (it.isNotBlank()) {
                            setCategoryTag(subCategoryTextView, it, getCategoryColor(item.category, true))
                            subCategoryTextView.visibility = View.VISIBLE
                        } else {
                            subCategoryTextView.visibility = View.GONE
                        }
                    } ?: run {
                        subCategoryTextView.visibility = View.GONE
                    }
                    
                    // æ˜¾ç¤ºåˆ†ç±»å®¹å™¨
                    categoryContainer?.visibility = View.VISIBLE
                }
                
                // ä½ç½®ä¿¡æ¯
                item.location?.let {
                    if (it.area.isBlank() || it.area == "æœªæŒ‡å®š") {
                        binding.locationContainer.visibility = View.GONE
                    } else {
                        locationTextView.text = it.getFullLocationString()
                        binding.locationContainer.visibility = View.VISIBLE
                    }
                } ?: run {
                    binding.locationContainer.visibility = View.GONE
                }

                // å•ä»·
                item.price?.let {
                    val priceUnitText = item.priceUnit ?: "å…ƒ"
                    priceTextView.text = "${formatNumber(it)} ${priceUnitText}"
                    priceContainer.visibility = View.VISIBLE
                } ?: run {
                    priceContainer.visibility = View.GONE
                }
                
                // æ€»ä»·
                item.totalPrice?.let {
                    val totalPriceUnitText = item.totalPriceUnit ?: "å…ƒ"
                    totalPriceTextView.text = "${formatNumber(it)} ${totalPriceUnitText}"
                    totalPriceContainer.visibility = View.VISIBLE
                } ?: run {
                    totalPriceContainer.visibility = View.GONE
                }
                
                // æ·»åŠ æ—¥æœŸ
                addDateTextView.text = dateFormat.format(item.addDate)
                
                // ä¿ä¿®æœŸ
                item.warrantyPeriod?.let { period ->
                    val unitText = when {
                        period % 365 == 0 -> "${period / 365}å¹´"
                        period % 30 == 0 -> "${period / 30}ä¸ªæœˆ"
                        else -> "${period}å¤©"
                    }
                    warrantyTextView.text = unitText
                    warrantyContainer.visibility = View.VISIBLE
                } ?: run {
                    warrantyContainer.visibility = View.GONE
                }
                
                // è¿‡æœŸæ—¥æœŸ
                item.expirationDate?.let {
                    expirationDateTextView.text = dateFormat.format(it)
                    expirationDateContainer.visibility = View.VISIBLE
                    
                    // è®¾ç½®çŠ¶æ€æ ‡ç­¾
                    setupExpirationStatus(it)
                } ?: run {
                    expirationDateContainer.visibility = View.GONE
                    statusTagView.visibility = View.GONE
                }

                // ä¿è´¨æœŸ
                item.shelfLife?.let { period ->
                    val unitText = when {
                        period % 365 == 0 -> "${period / 365}å¹´"
                        period % 30 == 0 -> "${period / 30}ä¸ªæœˆ"
                        else -> "${period}å¤©"
                    }
                    shelfLifeTextView.text = unitText
                    shelfLifeContainer.visibility = View.VISIBLE
                } ?: run {
                    shelfLifeContainer.visibility = View.GONE
                }

                // ç”Ÿäº§æ—¥æœŸ
                item.productionDate?.let {
                    productionDateTextView.text = dateFormat.format(it)
                    productionDateContainer.visibility = View.VISIBLE
                } ?: run {
                    productionDateContainer.visibility = View.GONE
                }

                // è´­ä¹°æ—¥æœŸ
                item.purchaseDate?.let {
                    purchaseDateTextView.text = dateFormat.format(it)
                    purchaseDateContainer.visibility = View.VISIBLE
                } ?: run {
                    purchaseDateContainer.visibility = View.GONE
                }

                // å¼€å°çŠ¶æ€
                item.openStatus?.let {
                    openStatusTextView.text = if (it == OpenStatus.OPENED) "å·²å¼€å°" else "æœªå¼€å°"
                    openStatusContainer.visibility = View.VISIBLE
                } ?: run {
                    openStatusContainer.visibility = View.GONE
                }
                
                // å¼€å°æ—¥æœŸ
                item.openDate?.let {
                    openDateTextView.text = dateFormat.format(it)
                    openDateContainer.visibility = View.VISIBLE
                } ?: run {
                    openDateContainer.visibility = View.GONE
                }
                
                // æ ‡ç­¾
                if (item.tags.isNotEmpty()) {
                    tagAdapter.submitList(item.tags.map { com.example.itemmanagement.data.entity.TagEntity(name = it.name) })
                    tagsRecyclerView.visibility = View.VISIBLE
                    binding.tagsContainer.visibility = View.VISIBLE
                } else {
                    // å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼Œéšè—æ ‡ç­¾åˆ—è¡¨å’Œæ ‡ç­¾å®¹å™¨
                    tagsRecyclerView.visibility = View.GONE
                    binding.tagsContainer.visibility = View.GONE
                }
                
                // å­£èŠ‚
                item.season?.let {
                    seasonTextView.text = it
                    seasonContainer.visibility = View.VISIBLE
                } ?: run {
                    seasonContainer.visibility = View.GONE
                }
                
                // å®¹é‡
                item.capacity?.let {
                    val unitText = item.capacityUnit ?: "ml"
                    capacityTextView.text = "${formatNumber(it)} $unitText"
                    capacityContainer.visibility = View.VISIBLE
                } ?: run {
                    capacityContainer.visibility = View.GONE
                }
                
                // åºåˆ—å·
                item.serialNumber?.let {
                    serialNumberTextView.text = it
                    serialNumberContainer.visibility = View.VISIBLE
                } ?: run {
                    serialNumberContainer.visibility = View.GONE
                }
                
                // å“ç‰Œ
                item.brand?.let {
                    brandTextView.text = it
                    brandContainer.visibility = View.VISIBLE
                } ?: run {
                    brandContainer.visibility = View.GONE
                }
                
                item.purchaseChannel?.let {
                    purchaseChannelTextView.text = it
                    purchaseChannelContainer.visibility = View.VISIBLE
                } ?: run {
                    purchaseChannelContainer.visibility = View.GONE
                }
                
                item.storeName?.let {
                    storeNameTextView.text = it
                    storeNameContainer.visibility = View.VISIBLE
                } ?: run {
                    storeNameContainer.visibility = View.GONE
                }
                
                // ä¿ä¿®ä¿¡æ¯
                item.warrantyEndDate?.let { endDate ->
                    warrantyEndDateTextView.text = dateFormat.format(endDate)
                    warrantyEndContainer.visibility = View.VISIBLE
                    
                    // è®¡ç®—ä¿ä¿®è¿›åº¦æ¡
                    setupWarrantyProgress(item.purchaseDate ?: item.addDate, endDate)
                } ?: run {
                    warrantyEndContainer.visibility = View.GONE
                    warrantyProgressBar.visibility = View.GONE
                }

                // è§„æ ¼ä¸å¤‡æ³¨
                // è§„æ ¼
                item.specification?.let {
                    specificationTextView.text = it
                    specificationContainer.visibility = View.VISIBLE
                } ?: run {
                    specificationContainer.visibility = View.GONE
                }
                
                // å¤‡æ³¨
                item.customNote?.let {
                    customNoteTextView.text = it
                    // å¦‚æœå¤‡æ³¨è¾ƒé•¿ï¼Œæ˜¾ç¤ºå±•å¼€æŒ‰é’®
                    if (it.length > 200) {
                        customNoteTextView.maxLines = 5
                        expandButton.visibility = View.VISIBLE
                    } else {
                        customNoteTextView.maxLines = Integer.MAX_VALUE
                        expandButton.visibility = View.GONE
                    }
                    customNoteTextView.visibility = View.VISIBLE
                } ?: run {
                    customNoteTextView.visibility = View.GONE
                    expandButton.visibility = View.GONE
                }

                // ç…§ç‰‡
                if (item.photos.isNotEmpty()) {
                    photoAdapter.submitList(item.photos.map { com.example.itemmanagement.data.entity.PhotoEntity(uri = it.uri, itemId = item.id) })
                    photoContainer.visibility = View.VISIBLE
                    
                    // è®¾ç½®ç…§ç‰‡æŒ‡ç¤ºå™¨
                    setupPhotoIndicators(item.photos.size)
                } else {
                    photoContainer.visibility = View.GONE
                }
                
                // æ ¹æ®å†…å®¹å†³å®šå¡ç‰‡çš„å¯è§æ€§
                updateCardVisibility()
            }
        }
    }
    
    private fun updateCardVisibility() {
        // å…³é”®ä¿¡æ¯å¡ç‰‡ï¼šå¦‚æœæœ‰æ•°é‡ã€ä½ç½®ã€è¯„åˆ†ã€åˆ†ç±»ã€æ ‡ç­¾æˆ–å¼€å°çŠ¶æ€ï¼Œåˆ™æ˜¾ç¤º
        val hasKeyInfo = binding.quantityTextView.visibility == View.VISIBLE ||
                binding.locationContainer.visibility == View.VISIBLE ||
                binding.ratingContainer.visibility == View.VISIBLE ||
                binding.categoryTextView.visibility == View.VISIBLE ||
                binding.openStatusContainer.visibility == View.VISIBLE ||
                binding.shelfLifeContainer.visibility == View.VISIBLE ||
                binding.tagsRecyclerView.adapter?.itemCount ?: 0 > 0
        
        binding.keyInfoCard.visibility = if (hasKeyInfo) View.VISIBLE else View.GONE
        
        // ç‰©å“çŠ¶æ€å¡ç‰‡ï¼šå¦‚æœæœ‰ä¿è´¨æœŸã€ä¿ä¿®æœŸã€å­£èŠ‚ã€å¼€å°çŠ¶æ€ã€è¯„åˆ†æˆ–æ ‡ç­¾ï¼Œåˆ™æ˜¾ç¤º
        val hasStatusInfo = binding.shelfLifeContainer.visibility == View.VISIBLE ||
                binding.warrantyContainer.visibility == View.VISIBLE ||
                binding.seasonContainer.visibility == View.VISIBLE ||
                binding.openStatusContainer.visibility == View.VISIBLE ||
                binding.ratingContainer.visibility == View.VISIBLE ||
                binding.tagsContainer.visibility == View.VISIBLE
        
        binding.keyInfoCard2.visibility = if (hasStatusInfo) View.VISIBLE else View.GONE
        
        // çŠ¶æ€ä¸æ—¥æœŸå¡ç‰‡ï¼šå¦‚æœæœ‰ä»»ä½•æ—¥æœŸä¿¡æ¯ï¼Œåˆ™æ˜¾ç¤º
        val hasDateInfo = binding.expirationDateContainer.visibility == View.VISIBLE ||
                binding.productionDateContainer.visibility == View.VISIBLE ||
                binding.purchaseDateContainer.visibility == View.VISIBLE ||
                binding.openDateContainer.visibility == View.VISIBLE ||
                binding.warrantyEndContainer.visibility == View.VISIBLE
        
        binding.dateCard.visibility = if (hasDateInfo) View.VISIBLE else View.GONE
        
        // å•†ä¸šä¿¡æ¯å¡ç‰‡ï¼šå¦‚æœæœ‰å“ç‰Œã€ä»·æ ¼ã€è´­ä¹°æ¸ é“ç­‰ä¿¡æ¯ï¼Œåˆ™æ˜¾ç¤º
        val hasCommercialInfo = binding.brandContainer.visibility == View.VISIBLE ||
                binding.priceContainer.visibility == View.VISIBLE ||
                binding.totalPriceContainer.visibility == View.VISIBLE ||
                binding.purchaseChannelContainer.visibility == View.VISIBLE ||
                binding.storeNameContainer.visibility == View.VISIBLE ||
                binding.serialNumberContainer.visibility == View.VISIBLE ||
                binding.warrantyContainer.visibility == View.VISIBLE
        
        binding.commercialInfoCard.visibility = if (hasCommercialInfo) View.VISIBLE else View.GONE
        
        // è§„æ ¼ä¸å¤‡æ³¨å¡ç‰‡ï¼šå¦‚æœæœ‰è§„æ ¼ã€å®¹é‡ã€å­£èŠ‚æˆ–å¤‡æ³¨ä¿¡æ¯ï¼Œåˆ™æ˜¾ç¤º
        val hasSpecsOrNotes = binding.specificationContainer.visibility == View.VISIBLE ||
                binding.capacityContainer.visibility == View.VISIBLE ||
                binding.seasonContainer.visibility == View.VISIBLE ||
                binding.customNoteTextView.visibility == View.VISIBLE
        
        binding.specsAndNotesCard.visibility = if (hasSpecsOrNotes) View.VISIBLE else View.GONE
    }
    
    private fun setupExpirationStatus(expirationDate: Date) {
        val today = Calendar.getInstance().time
        val diffInDays = TimeUnit.DAYS.convert(
            expirationDate.time - today.time,
            TimeUnit.MILLISECONDS
        )
        
        // è®¾ç½®çŠ¶æ€æ ‡ç­¾
        binding.statusTagView.apply {
            when {
                diffInDays < 0 -> {
                    text = "å·²è¿‡æœŸ"
                    background = ContextCompat.getDrawable(requireContext(), R.drawable.bg_status_error)
                    visibility = View.VISIBLE
                }
                diffInDays < 7 -> {
                    text = "å³å°†è¿‡æœŸ"
                    background = ContextCompat.getDrawable(requireContext(), R.drawable.bg_status_error)
                    visibility = View.VISIBLE
                }
                diffInDays < 30 -> {
                    text = "ä¸´æœŸ"
                    background = ContextCompat.getDrawable(requireContext(), R.drawable.bg_status_warning)
                    visibility = View.VISIBLE
                }
                else -> {
                    visibility = View.GONE
                }
            }
        }
    }
    
    private fun setupWarrantyProgress(startDate: Date, endDate: Date) {
        val today = Calendar.getInstance().time
        val totalDays = TimeUnit.DAYS.convert(
            endDate.time - startDate.time,
            TimeUnit.MILLISECONDS
        )
        val passedDays = TimeUnit.DAYS.convert(
            today.time - startDate.time,
            TimeUnit.MILLISECONDS
        )
        
        binding.warrantyProgressBar.apply {
            if (totalDays > 0) {
                progress = ((passedDays.toFloat() / totalDays) * 100).toInt().coerceIn(0, 100)
                visibility = View.VISIBLE
            } else {
                visibility = View.GONE
            }
        }
    }
    
    private fun setupPhotoIndicators(count: Int) {
        binding.photoIndicator.removeAllViews()
        
        if (count <= 1) {
            binding.photoIndicator.visibility = View.GONE
            return
        }
        
        binding.photoIndicator.visibility = View.VISIBLE
        
        for (i in 0 until count) {
            val dot = TextView(requireContext())
            dot.layoutParams = ViewGroup.LayoutParams(
                resources.getDimensionPixelSize(R.dimen.detail_indicator_diameter),
                resources.getDimensionPixelSize(R.dimen.detail_indicator_diameter)
            )
            dot.background = ContextCompat.getDrawable(requireContext(), R.drawable.dot_indicator)
            dot.isSelected = i == 0
            
            val layoutParams = ViewGroup.MarginLayoutParams(
                resources.getDimensionPixelSize(R.dimen.detail_indicator_diameter),
                resources.getDimensionPixelSize(R.dimen.detail_indicator_diameter)
            )
            layoutParams.setMargins(
                resources.getDimensionPixelSize(R.dimen.detail_indicator_spacing),
                0,
                resources.getDimensionPixelSize(R.dimen.detail_indicator_spacing),
                0
            )
            dot.layoutParams = layoutParams
            
            binding.photoIndicator.addView(dot)
        }
        
        // è®¾ç½®ViewPagerçš„é¡µé¢å˜åŒ–ç›‘å¬å™¨
        binding.photoViewPager.registerOnPageChangeCallback(object : androidx.viewpager2.widget.ViewPager2.OnPageChangeCallback() {
            override fun onPageSelected(position: Int) {
                // æ›´æ–°æŒ‡ç¤ºå™¨çŠ¶æ€
                for (i in 0 until binding.photoIndicator.childCount) {
                    binding.photoIndicator.getChildAt(i).isSelected = i == position
                }
            }
        })
    }
    
    private fun setCategoryTag(textView: TextView, text: String, color: Int) {
        textView.text = text
        textView.background.setTint(color)
    }
    
    private fun getCategoryColor(category: String, isSubCategory: Boolean = false): Int {
        val baseColorId = when (category.lowercase()) {
            "é£Ÿå“" -> R.color.category_food
            "è¯å“" -> R.color.category_medicine
            "ç”µå­äº§å“" -> R.color.category_electronics
            "è¡£ç‰©" -> R.color.category_clothing
            else -> R.color.category_other
        }
        
        return if (isSubCategory) {
            // å­åˆ†ç±»é¢œè‰²ç•¥æ·±ä¸€ç‚¹
            ContextCompat.getColor(requireContext(), baseColorId)
        } else {
            ContextCompat.getColor(requireContext(), baseColorId)
        }
    }
    
    private fun getStatusText(status: String): String {
        return when (status) {
            "IN_STOCK" -> "åœ¨åº“"
            "OUT_OF_STOCK" -> "ç¼ºè´§"
            "EXPIRED" -> "è¿‡æœŸ"
            "CONSUMED" -> "å·²æ¶ˆè€—"
            "LENT" -> "å·²å€Ÿå‡º"
            "LOST" -> "ä¸¢å¤±"
            "DAMAGED" -> "æŸå"
            else -> status
        }
    }

    private fun observeError() {
        viewModel.errorMessage.observe(viewLifecycleOwner) { errorMessage ->
            if (!errorMessage.isNullOrEmpty()) {
                Toast.makeText(context, errorMessage, Toast.LENGTH_LONG).show()
            }
        }
    }

    override fun onDestroyView() {
        super.onDestroyView()
        _binding = null
    }

    /**
     * æ ¼å¼åŒ–æ•°å­—ï¼Œå¦‚æœæ˜¯æ•´æ•°åˆ™ä¸æ˜¾ç¤ºå°æ•°ç‚¹ï¼Œå¦‚æœæœ‰å°æ•°åˆ™ä¿ç•™å°æ•°
     */
    private fun formatNumber(number: Double): String {
        return if (number == number.toInt().toDouble()) {
            number.toInt().toString()
        } else {
            number.toString()
        }
    }
}
