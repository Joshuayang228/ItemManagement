package com.example.itemmanagement.ui.edit

import androidx.lifecycle.viewModelScope
import com.example.itemmanagement.data.ItemRepository
import com.example.itemmanagement.data.entity.LocationEntity
import com.example.itemmanagement.data.entity.PhotoEntity
import com.example.itemmanagement.data.entity.TagEntity
import com.example.itemmanagement.data.mapper.toItemEntity
import com.example.itemmanagement.data.mapper.toLocationEntity
import com.example.itemmanagement.data.mapper.toItem
import com.example.itemmanagement.data.model.Item
import com.example.itemmanagement.data.model.OpenStatus
import com.example.itemmanagement.ui.add.Field
import com.example.itemmanagement.ui.add.AddItemViewModel.FieldProperties
import com.example.itemmanagement.ui.add.AddItemViewModel.ValidationType  
import com.example.itemmanagement.ui.add.AddItemViewModel.DisplayStyle
import com.example.itemmanagement.ui.base.BaseItemViewModel
import com.example.itemmanagement.ui.base.ItemStateCacheViewModel
import kotlinx.coroutines.launch
import android.net.Uri
import java.text.SimpleDateFormat
import java.util.*

/**
 * 编辑物品 ViewModel
 * 
 * 继承自 BaseItemViewModel，专门处理编辑现有物品的业务逻辑。
 * 每个要编辑的物品都有独立的缓存空间，确保同时编辑多个物品时数据不混淆。
 */
@Deprecated(
    message = "请使用新架构：NewEditItemViewModel",
    replaceWith = ReplaceWith("NewEditItemViewModel")
)
class EditItemViewModel(
    repository: ItemRepository,
    cacheViewModel: ItemStateCacheViewModel,
    private val itemId: Long
) : BaseItemViewModel(repository, cacheViewModel) {

    init {
        // 初始化字段属性
        initializeAllFieldProperties()
        
        // 尝试从缓存恢复数据，如果有的话
        if (cacheViewModel.hasEditItemCache(itemId)) {
            loadFromCache()
        } else {
            // 如果没有缓存，从数据库加载物品数据
            loadItemFromDatabase()
        }
    }

    // --- 实现抽象方法 ---

    override fun getCurrentCache(): Any {
        return cacheViewModel.getEditItemCache(itemId)
    }

    override fun getCacheKey(): String {
        return "EDIT_ITEM_$itemId"
    }

    override fun loadDataFromCache() {
        val cache = cacheViewModel.getEditItemCache(itemId)
        // 类型安全的缓存加载，编辑模式专用
        fieldValues = cache.fieldValues.toMutableMap()
        _selectedFields.value = cache.selectedFields
        _photoUris.value = cache.photoUris
        _selectedTags.value = cache.selectedTags
        customOptionsMap = cache.customOptions.toMutableMap()
        customUnitsMap = cache.customUnits.toMutableMap()
        customTagsMap = cache.customTags.toMutableMap()
    }

    override fun saveDataToCache() {
        val cache = cacheViewModel.getEditItemCache(itemId)
        // 类型安全的缓存保存，编辑模式专用
        cache.fieldValues = fieldValues.toMutableMap()
        cache.selectedFields = _selectedFields.value ?: setOf()
        cache.photoUris = _photoUris.value ?: emptyList()
        cache.selectedTags = _selectedTags.value ?: mapOf()
        cache.customOptions = customOptionsMap.toMutableMap()
        cache.customUnits = customUnitsMap.toMutableMap()
        cache.customTags = customTagsMap.toMutableMap()
        cache.originalItemId = itemId // 编辑模式特有的字段
    }

    override suspend fun saveOrUpdateItem() {
        // 验证数据
        val item = buildItemFromFields()
        val (isValid, errorMessage) = validateItem(item)
        
        if (!isValid) {
            _errorMessage.value = errorMessage ?: "数据验证失败"
            _saveResult.value = false
            return
        }

        try {
            // 构建实体对象
            val itemEntity = item.toItemEntity()
            
            // 准备位置实体
            val locationEntity = item.location?.let { 
                if (it.area != "未指定") it.toLocationEntity() else null
            }
            
            // 准备照片实体
            val photoEntities = mutableListOf<PhotoEntity>()
            _photoUris.value?.forEachIndexed { index, uri ->
                photoEntities.add(
                    PhotoEntity(
                        itemId = itemId, // 编辑模式，使用现有的itemId
                        uri = uri.toString(),
                        isMain = index == 0,
                        displayOrder = index
                    )
                )
            }
            
            // 准备标签实体
            val tagEntities = mutableListOf<TagEntity>()
            item.tags.forEach { tag ->
                tagEntities.add(TagEntity(name = tag.name, color = tag.color))
            }
            
            // 更新到数据库
            repository.updateItemWithDetails(itemId, itemEntity, locationEntity, photoEntities, tagEntities)
            
            _saveResult.value = true
            _errorMessage.value = "物品更新成功"
            
        } catch (e: Exception) {
            _errorMessage.value = e.message ?: "更新失败：未知错误"
            _saveResult.value = false
        }
    }

    // --- 私有辅助方法 ---

    /**
     * 从数据库加载物品数据
     */
    private fun loadItemFromDatabase() {
        viewModelScope.launch {
            try {
                val item = repository.getItemById(itemId)
                item?.let { 
                    loadItemData(it)
                }
            } catch (e: Exception) {
                _errorMessage.value = "加载物品数据失败：${e.message}"
            }
        }
    }

    /**
     * 加载物品数据到表单中
     */
    private fun loadItemData(item: Item) {
        // 清除当前数据
        fieldValues.clear()
        
        // 填充基础信息
        saveFieldValue("名称", item.name)
        
        // 处理数量字段 - 如果是整数，去掉小数点后的.0
        val quantityStr = if (item.quantity == item.quantity.toInt().toDouble()) {
            item.quantity.toInt().toString()
        } else {
            item.quantity.toString()
        }
        saveFieldValue("数量", quantityStr)
        
        // 保存数量单位
        item.unit?.let { if (it.isNotBlank() && it != "个") saveFieldValue("数量_unit", it) }
        
        // 只有当分类不是"未指定"时才保存分类字段
        if (!item.category.isNullOrBlank() && item.category != "未指定") {
            saveFieldValue("分类", item.category)
        }
        
        // 只有当位置区域不是"未指定"或空时才保存位置字段
        item.location?.let { location ->
            if (!location.area.isNullOrBlank() && location.area != "未指定") {
                saveFieldValue("位置_area", location.area)
                location.container?.let { if (it.isNotBlank()) saveFieldValue("位置_container", it) }
                location.sublocation?.let { if (it.isNotBlank()) saveFieldValue("位置_sublocation", it) }
            }
        }
        
        // 日期类字段
        val dateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
        item.productionDate?.let { saveFieldValue("生产日期", dateFormat.format(it)) }
        item.expirationDate?.let { saveFieldValue("保质过期时间", dateFormat.format(it)) }
        saveFieldValue("添加日期", dateFormat.format(item.addDate))
        
        // 开封状态
        item.openStatus?.let { 
            val openStatusValue = if (it == OpenStatus.OPENED) "已开封" else "未开封"
            saveFieldValue("开封状态", openStatusValue)
        }
        item.openDate?.let { saveFieldValue("开封时间", dateFormat.format(it)) }
        
        // 其他字段 - 只保存非空且非"未指定"的值
        item.brand?.let { if (it.isNotBlank() && it != "未指定") saveFieldValue("品牌", it) }
        item.specification?.let { if (it.isNotBlank() && it != "未指定") saveFieldValue("规格", it) }
        
        // 价格字段
        item.price?.let { 
            val priceStr = if (it == it.toInt().toDouble()) {
                it.toInt().toString()
            } else {
                it.toString()
            }
            saveFieldValue("单价", priceStr)
            item.priceUnit?.let { unit -> saveFieldValue("单价_unit", unit) }
        }
        
        // 继续填充其他字段...
        item.purchaseChannel?.let { if (it.isNotBlank() && it != "未指定") saveFieldValue("购买渠道", it) }
        item.storeName?.let { if (it.isNotBlank() && it != "未指定") saveFieldValue("商家名称", it) }
        item.subCategory?.let { if (it.isNotBlank() && it != "未指定") saveFieldValue("子分类", it) }
        item.customNote?.let { if (it.isNotBlank()) saveFieldValue("备注", it) }
        
        // 购买日期
        item.purchaseDate?.let { saveFieldValue("购买日期", dateFormat.format(it)) }
        
        // 总价字段
        item.totalPrice?.let { 
            val totalPriceStr = if (it == it.toInt().toDouble()) {
                it.toInt().toString()
            } else {
                it.toString()
            }
            saveFieldValue("总价", totalPriceStr)
            item.totalPriceUnit?.let { unit -> saveFieldValue("总价_unit", unit) }
        }
        
        // 保质期和保修期
        item.shelfLife?.let { 
            saveFieldValue("保质期", it.toString())
            // 为保质期添加单位（默认为天）
            saveFieldValue("保质期_unit", "天")
        }
        
        item.warrantyPeriod?.let { 
            saveFieldValue("保修期", it.toString())
            // 为保修期添加单位（默认为天）
            saveFieldValue("保修期_unit", "天")
        }
        
        item.warrantyEndDate?.let { saveFieldValue("保修到期时间", dateFormat.format(it)) }
        
        // 序列号
        item.serialNumber?.let { if (it.isNotBlank()) saveFieldValue("序列号", it) }
        
        // 容量字段
        item.capacity?.let { 
            val capacityStr = if (it == it.toInt().toDouble()) {
                it.toInt().toString()
            } else {
                it.toString()
            }
            saveFieldValue("容量", capacityStr)
            item.capacityUnit?.let { unit -> saveFieldValue("容量_unit", unit) }
        }
        
        // 评分字段
        item.rating?.let { 
            val ratingStr = if (it == it.toInt().toDouble()) {
                it.toInt().toString()
            } else {
                it.toString()
            }
            saveFieldValue("评分", ratingStr)
        }
        
        // 处理季节字段 - 将逗号分隔的字符串转换为Set
        item.season?.let { 
            if (it.isNotBlank() && it != "未指定") {
                val seasonSet = it.split(",").map { s -> s.trim() }.toSet()
                saveFieldValue("季节", seasonSet)
            }
        }
        
        // 心愿单和高周转字段
        saveFieldValue("加入心愿单", item.isWishlistItem.toString())
        saveFieldValue("高周转", item.isHighTurnover.toString())
        
        // 处理标签数据
        if (item.tags.isNotEmpty()) {
            val tagSet = item.tags.map { it.name }.toSet()
            saveFieldValue("标签", tagSet)
        }
        
        // 将Photo对象转换为Uri列表
        val uris = item.photos.map { Uri.parse(it.uri) }
        _photoUris.value = uris
        
        // 创建字段集合 - 根据物品实际数据动态确定要显示的字段
        // 字段顺序与添加物品保持一致：基础信息 -> 分类 -> 日期类 -> 数字类 -> 商业类 -> 其他
        val fieldsToAdd = mutableSetOf<Field>()
        
        // 基础信息类字段 (1-4)
        fieldsToAdd.add(Field("基础信息", "名称", true, 1))
        fieldsToAdd.add(Field("基础信息", "数量", true, 2))
        
        if (item.location != null && !item.location.area.isNullOrBlank() && item.location.area != "未指定") {
            fieldsToAdd.add(Field("基础信息", "位置", true, 3))
        }
        
        if (!item.customNote.isNullOrBlank()) {
            fieldsToAdd.add(Field("基础信息", "备注", true, 4))
        }
        
        // 分类字段 (5-6)
        if (!item.category.isNullOrBlank() && item.category != "未指定") {
            fieldsToAdd.add(Field("分类", "分类", true, 5))
        }
        
        if (!item.subCategory.isNullOrBlank()) {
            fieldsToAdd.add(Field("分类", "子分类", true, 6))
        }
        
        if (item.tags.isNotEmpty()) {
            fieldsToAdd.add(Field("分类", "标签", true, 7))
        }
        
        if (!item.season.isNullOrBlank()) {
            fieldsToAdd.add(Field("分类", "季节", true, 8))
        }
        
        // 日期类字段 (7+)
        fieldsToAdd.add(Field("日期类", "添加日期", true, 9))
        
        if (item.openDate != null) {
            fieldsToAdd.add(Field("日期类", "开封时间", true, 10))
        }
        
        if (item.purchaseDate != null) {
            fieldsToAdd.add(Field("日期类", "购买日期", true, 11))
        }
        
        if (item.productionDate != null) {
            fieldsToAdd.add(Field("日期类", "生产日期", true, 12))
        }
        
        if (item.shelfLife != null && item.shelfLife > 0) {
            fieldsToAdd.add(Field("日期类", "保质期", true, 13))
        }
        
        if (item.expirationDate != null) {
            fieldsToAdd.add(Field("日期类", "保质过期时间", true, 14))
        }
        
        if (item.warrantyPeriod != null && item.warrantyPeriod > 0) {
            fieldsToAdd.add(Field("日期类", "保修期", true, 15))
        }
        
        if (item.warrantyEndDate != null) {
            fieldsToAdd.add(Field("日期类", "保修到期时间", true, 16))
        }
        
        // 数字类字段
        if (item.capacity != null && item.capacity > 0) {
            fieldsToAdd.add(Field("数字类", "容量", true, 17))
        }
        
        if (item.rating != null && item.rating > 0) {
            fieldsToAdd.add(Field("数字类", "评分", true, 18))
        }
        
        if (item.price != null && item.price > 0) {
            fieldsToAdd.add(Field("数字类", "单价", true, 19))
        }
        
        if (item.totalPrice != null && item.totalPrice > 0) {
            fieldsToAdd.add(Field("数字类", "总价", true, 20))
        }
        
        // 商业类字段
        if (!item.brand.isNullOrBlank()) {
            fieldsToAdd.add(Field("商业类", "品牌", true, 21))
        }
        
        if (!item.purchaseChannel.isNullOrBlank()) {
            fieldsToAdd.add(Field("商业类", "购买渠道", true, 22))
        }
        
        if (!item.storeName.isNullOrBlank()) {
            fieldsToAdd.add(Field("商业类", "商家名称", true, 23))
        }
        
        if (!item.serialNumber.isNullOrBlank()) {
            fieldsToAdd.add(Field("商业类", "序列号", true, 24))
        }
        
        // 其他字段
        if (!item.specification.isNullOrBlank()) {
            fieldsToAdd.add(Field("其他", "规格", true, 25))
        }
        
        if (item.openStatus != null) {
            fieldsToAdd.add(Field("其他", "开封状态", true, 26))
        }
        
        // 更新选中的字段
        _selectedFields.value = fieldsToAdd
        
        // 保存到缓存
        saveToCache()
    }

    /**
     * 从字段值构建Item对象
     */
    private fun buildItemFromFields(): Item {
        // 这里需要根据fieldValues构建完整的Item对象
        // 这是一个简化版本，实际实现需要处理所有字段
        val name = fieldValues["名称"] as? String ?: ""
        val quantityStr = fieldValues["数量"] as? String ?: "1"
        val quantity = quantityStr.toDoubleOrNull() ?: 1.0
        
        return Item(
            id = itemId, // 编辑模式，使用现有ID
            name = name,
            quantity = quantity,
            unit = "个", // 使用固定默认值，不再从字段中读取
            location = null, // TODO: 从位置字段构建 Location 对象
            category = fieldValues["分类"] as? String ?: "未指定",
            productionDate = null, // TODO: 从字段解析日期
            expirationDate = null, // TODO: 从字段解析日期
            openStatus = null,
            openDate = null,
            brand = fieldValues["品牌"] as? String,
            specification = fieldValues["规格"] as? String,
            stockWarningThreshold = (fieldValues["库存预警值"] as? String)?.toIntOrNull(),
            price = (fieldValues["单价"] as? String)?.toDoubleOrNull(),
            purchaseChannel = fieldValues["购买渠道"] as? String,
            storeName = fieldValues["商家名称"] as? String,
            subCategory = fieldValues["子分类"] as? String,
            customNote = fieldValues["备注"] as? String,
            season = fieldValues["季节"] as? String,
            capacity = (fieldValues["容量"] as? String)?.toDoubleOrNull(),
            capacityUnit = fieldValues["容量单位"] as? String,
            rating = (fieldValues["评分"] as? String)?.toDoubleOrNull(),
            totalPrice = (fieldValues["总价"] as? String)?.toDoubleOrNull(),
            purchaseDate = null, // TODO: 从字段解析日期
            shelfLife = (fieldValues["保质期"] as? String)?.toIntOrNull(),
            warrantyPeriod = (fieldValues["保修期"] as? String)?.toIntOrNull(),
            warrantyEndDate = null, // TODO: 从字段解析日期
            serialNumber = fieldValues["序列号"] as? String,
            addDate = Date() // 这里应该保持原有的添加日期
        )
    }

    /**
     * 验证Item对象
     */
    private fun validateItem(item: Item): Pair<Boolean, String?> {
        return when {
            item.name.isBlank() -> Pair(false, "物品名称不能为空")
            item.quantity <= 0.0 -> Pair(false, "数量必须大于0")
            else -> Pair(true, null)
        }
    }

    /**
     * 初始化所有字段属性
     */
    private fun initializeAllFieldProperties() {
        // 调用父类的基础属性初始化
        super.initializeDefaultFieldProperties()
        
        // 添加更多字段属性定义...
        setFieldProperties("备注", FieldProperties(
            validationType = ValidationType.TEXT,
            hint = "请输入备注",
            isMultiline = true,
            maxLines = 5
        ))

        setFieldProperties("子分类", FieldProperties(
            options = emptyList(),
            isCustomizable = true
        ))

        setFieldProperties("标签", FieldProperties(
            displayStyle = DisplayStyle.TAG,
            isMultiSelect = true,
            isCustomizable = true,
            options = listOf("重要", "易碎", "易腐", "贵重", "常用")
        ))
        
        setFieldProperties("开封状态", FieldProperties(
            options = listOf("已开封", "未开封"),
            isCustomizable = false
        ))
        
        // 继续添加其他字段...
    }

    /**
     * 获取正在编辑的物品ID
     */
    fun getEditingItemId(): Long = itemId
} 